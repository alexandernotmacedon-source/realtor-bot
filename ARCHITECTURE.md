# Realtor Bot - Архитектура данных

## Общая схема

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        ИСТОЧНИКИ ДАННЫХ                                │
├─────────────────┬─────────────────┬─────────────────┬───────────────────┤
│ Sofia's Drive   │ Property Finder │  MyHome.ge      │  Прямая связь    │
│ (29 папок)      │ (скрапер)       │  (будущее)      │  с девелоперами  │
└────────┬────────┴────────┬────────┴────────┬────────┴─────────┬─────────┘
         │                 │                 │                  │
         └─────────────────┴─────────────────┴──────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                     ОБРАБОТКА И ХРАНЕНИЕ                               │
├─────────────────────────────────────────────────────────────────────────┤
│  Google Sheets API          │  Локальные файлы       │  Notion CRM     │
│  ├── Клиенты (лиды)         │  ├── data/drafts/      │  ├── Архитектура│
│  ├── История поиска         │  ├── data/sessions/    │  ├── Документация│
│  └── Статистика             │  └── data/logs/        │  └── Roadmap    │
└─────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                     TELEGRAM BOT (@Property_Batumi_Bot)                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐ │
│  │  AI Chat     │  │  Поиск       │  │  Форма       │  │  Admin      │ │
│  │  (Kimi/Groq) │  │  квартир     │  │  клиента     │  │  панель     │ │
│  └──────────────┘  └──────────────┘  └──────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
```

## 1. Источники данных по квартирам

### 1.1 Sofia's Google Drive (основной)
**Статус:** Настроен, ждёт авторизации Google Drive API

**Что там:**
- 29 папок девелоперов (Batumi Hills, Next White, и т.д.)
- 7 веб-сайтов с каталогами
- 3 Google Sheets с инвентарём

**Локальная копия:** `realtor-bot/data/developer_links.json`

**Интеграция:**
```python
# Google Drive API → парсинг PDF/Excel → база квартир
# Требуется: credentials.json + OAuth авторизация
```

### 1.2 Property Finder (скрапер)
**Статус:** Работает, но нужен рефакторинг

**Как работает:**
- Сканирует propertyfinder.ge по фильтрам
- Сохраняет новые объявления
- Отправляет уведомления

**Проблема:** Сайт обновился, скрапер падает на некоторых страницах

### 1.3 MyHome.ge (планируется)
**Статус:** В очереди на разработку

---

## 2. Хранение клиентских данных

### 2.1 Активные разговоры (Автосейв)
**Где:** `realtor-bot/data/drafts/<chat_id>.json`

**Что хранится:**
```json
{
  "chat_id": 123456789,
  "status": "DRAFT", // DRАFT → NEW → CONTACTED → CLOSED
  "created_at": "2026-02-17T10:00:00",
  "updated_at": "2026-02-17T10:30:00",
  "client_info": {
    "name": "Иван",
    "budget": "до $150k",
    "rooms": "2-3",
    "district": "Батуми центр",
    "deadline": "июнь 2026"
  },
  "messages": [...],
  "notes": "..."
}
```

**Фича:** Автосохранение после КАЖДОГО ответа клиента. Данные не теряются даже при перезапуске бота.

### 2.2 Google Sheets (основная база)
**Где:** Google Drive → Realtor Bot → Clients Database

**Структура:**
| ID | Дата | Имя | Телефон | Бюджет | Комнаты | Район | Статус | Источник | История |
|----|------|-----|---------|--------|---------|-------|--------|----------|---------|
| 1 | 17.02 | Иван | +7912... | $150k | 2-3 | Центр | NEW | Bot | [ссылка] |

**Статусы:**
- `DRAFT` — разговор в процессе
- `NEW` — форма заполнена, ждёт обработки
- `CONTACTED` — риелтор связался
- `VIEWING` — назначен показ
- `OFFER` — сделано предложение
- `CLOSED` — сделка завершена
- `LOST` — клиент отвалился

### 2.3 История сообщений
**Где:** `realtor-bot/data/sessions/<chat_id>/<date>.jsonl`

**Что хранится:** Полный лог переписки для анализа и обучения AI.

---

## 3. Технический стек

### 3.1 Компоненты
```
┌────────────────────────────────────────┐
│  Hostinger VPS (Docker)               │
│  ┌──────────────────────────────────┐  │
│  │  realtor-bot (Python)            │  │
│  │  ├── python-telegram-bot         │  │
│  │  ├── openai/moonshot API         │  │
│  │  ├── google-api-python-client    │  │
│  │  └── aiohttp (async)             │  │
│  └──────────────────────────────────┘  │
│  ┌──────────────────────────────────┐  │
│  │  property-finder-monitor (Python)│  │
│  │  └── playwright + beautifulsoup  │  │
│  └──────────────────────────────────┘  │
│  ┌──────────────────────────────────┐  │
│  │  PostgreSQL (опционально)        │  │
│  │  └── для масштабирования         │  │
│  └──────────────────────────────────┘  │
└────────────────────────────────────────┘
```

### 3.2 API Keys / Токены
| Сервис | Статус | Где |
|--------|--------|-----|
| Telegram Bot Token | ✅ Работает | `.env` |
| Moonshot API | ✅ Работает | `.env` |
| Groq API (Whisper) | ✅ Работает | `.env` |
| Google Drive API | ⏳ Ждёт авторизации | нужен `credentials.json` |
| Notion API | ⏳ Не настроен | нужен токен |

---

## 4. Поток данных (User Journey)

```
1. Пользователь пишет боту
        ↓
2. AI (Kimi) анализирует запрос
        ↓
3. Если клиент → запускает форму:
   - Бюджет?
   - Комнаты?
   - Район?
   - Сроки?
        ↓
4. Автосейв после каждого ответа
        ↓
5. После завершения формы:
   - Статус DRАFT → NEW
   - Отправка в Google Sheets
   - Уведомление риелтору
        ↓
6. Риелтор забирает лид из таблицы
   - Меняет статус на CONTACTED
   - Работает с клиентом
        ↓
7. Результат записывается в таблицу
```

---

## 5. Безопасность и бэкапы

### 5.1 Автосейв (критично!)
- Данные сохраняются после КАЖДОГО сообщения
- Независимо от сбоев бота или сервера
- Файлы в `data/drafts/` — JSON, читаемые человеком

### 5.2 Резервное копирование
- Git коммиты (все изменения в репозитории)
- Google Sheets — облачное хранение
- Локальные логи — ротация по 30 дней

---

## 6. Что нужно сделать (TODO)

### Ближайшее (эта неделя)
- [ ] Авторизовать Google Drive API (загрузить `credentials.json`)
- [ ] Проверить работу импорта из папок Софии
- [ ] Пофиксить Property Finder скрапер
- [ ] Настроить Notion API для CRM

### Среднесрочное (месяц)
- [ ] Подключить MyHome.ge
- [ ] Добавить фильтры поиска в боте
- [ ] Интеграция с Google Calendar (показы)
- [ ] Статистика и аналитика

### Долгосрочное (квартал)
- [ ] Мобильное приложение для риелторов
- [ ] Автоматическая рассылка новых объектов
- [ ] AI-рекомендации (похожие квартиры)

---

## 7. FAQ для команды

**Q: Где посмотреть всех клиентов?**
A: Google Sheets → Clients Database

**Q: Что если бот упал во время разговора?**
A: Данные сохранены в `data/drafts/`. После перезапуска бот продолжит с того же места.

**Q: Откуда берутся квартиры в поиске?**
A: Пока только вручную из Google Drive Софии. Автоматический парсинг в разработке.

**Q: Как добавить нового девелопера?**
A: Добавить папку в `developer_links.json` → перезапустить бот.

---

*Документ создан: 2026-02-17*
*Последнее обновление: 2026-02-17*
